# Integration Tests for Auth Refactor

This directory contains comprehensive integration tests for the auth refactor implementation, validating all the requirements specified in task 12.2.

## Test Coverage

### 1. Complete Authentication Flow (Requirements 4.5, 5.5, 6.5)

#### Signup ‚Üí Confirmation ‚Üí Role Selection ‚Üí Dashboard Flow
- **Signup Process**: Validates user registration with email/password and OAuth providers
- **Email Confirmation**: Tests email verification callback handling
- **Role Selection**: Validates mandatory role selection (mentor/mentee) after confirmation
- **Dashboard Redirect**: Ensures proper redirection based on selected role

#### OAuth Provider Integration
- **Google OAuth**: Tests Google authentication flow with proper provider mapping
- **LinkedIn OAuth**: Tests LinkedIn authentication with `linkedin_oidc` provider
- **Callback Handling**: Validates OAuth callback processing and redirection

#### Error Handling
- **Email Not Confirmed**: Tests handling of unconfirmed email login attempts
- **Invalid Credentials**: Validates error messages for wrong email/password
- **Token Expiration**: Tests expired token handling and re-authentication flows

### 2. Mentor Verification Flow (Requirements 9.5)

#### Admin Dashboard Functionality
- **Unverified Mentor Listing**: Tests display of mentors pending verification
- **Verification Actions**: Validates admin ability to verify/reject mentors
- **Access Control**: Ensures only admins can access verification features

#### Verification Process
- **API Integration**: Tests `/api/mentors/verify` endpoint functionality
- **Status Updates**: Validates mentor profile updates after verification
- **Public Listing**: Tests verified mentor appearance in public mentor list

#### Error Scenarios
- **Authorization Errors**: Tests non-admin access rejection
- **Invalid Mentor IDs**: Validates error handling for non-existent mentors
- **Network Failures**: Tests graceful degradation on API failures

### 3. Appointment and Google Calendar Integration (Requirements 11.5)

#### Appointment Booking Flow
- **Availability Display**: Tests mentor availability presentation
- **Booking Form**: Validates appointment booking form functionality
- **Conflict Detection**: Tests time slot conflict resolution
- **Confirmation Process**: Validates appointment confirmation workflow

#### Google Calendar Integration
- **Event Creation**: Tests automatic Google Calendar event creation
- **Meet Link Generation**: Validates Google Meet link inclusion
- **Attendee Management**: Tests proper attendee addition to calendar events
- **Event Details**: Validates event title, description, and timing

#### Validation and Error Handling
- **Input Validation**: Tests required field validation
- **Future Date Requirement**: Validates scheduling only future appointments
- **Mentor Verification**: Ensures only verified mentors can receive bookings
- **Conflict Resolution**: Tests handling of double-booked time slots

## Test Files

### `auth-integration.test.ts`
Core integration tests focusing on API endpoints, error handling, and business logic validation without complex component mocking.

**Key Test Areas:**
- API endpoint structure validation
- Error response handling
- Authentication flow patterns
- Database schema requirements
- Google Calendar integration
- Security validation

### `auth-flow.integration.test.tsx`
Component-level integration tests for the complete user authentication journey.

**Key Test Areas:**
- Signup form integration
- Email confirmation simulation
- Role selection component
- Dashboard redirection
- OAuth provider buttons

### `mentor-verification.integration.test.tsx`
Integration tests for the mentor verification workflow from admin perspective.

**Key Test Areas:**
- Admin dashboard functionality
- Mentor verification API calls
- Status update propagation
- Public listing updates

### `appointment-calendar.integration.test.tsx`
Integration tests for appointment booking and Google Calendar integration.

**Key Test Areas:**
- Appointment booking flow
- Calendar event creation
- Conflict detection
- Dashboard appointment display

### `test-runner.integration.test.tsx`
Comprehensive end-to-end test scenarios combining multiple workflows.

**Key Test Areas:**
- Complete user journeys
- Cross-feature integration
- Error handling across workflows
- Role-based access control

## Tipos de Teste - Esclarecimento

### üß™ O que s√£o estes "Testes de Integra√ß√£o"?

**Importante:** Os testes neste diret√≥rio s√£o mais precisamente **testes de integra√ß√£o de API/servi√ßos** usando Jest, n√£o testes E2E completos.

#### Hierarquia de Testes:
1. **Testes Unit√°rios** (Jest)
   - Testam fun√ß√µes/componentes isolados
   - Mockam todas as depend√™ncias
   - Exemplo: `useAuth.test.ts`

2. **Testes de Integra√ß√£o** (Jest + Testing Library) ‚Üê **Estamos aqui**
   - Testam m√∫ltiplos componentes/servi√ßos juntos
   - Mocks parciais (APIs, mas n√£o l√≥gica de neg√≥cio)
   - Exemplo: Fluxo completo de autentica√ß√£o

3. **Testes End-to-End** (Cypress/Playwright)
   - Testam aplica√ß√£o completa no navegador
   - Sem mocks, sistemas reais
   - Exemplo: Usu√°rio real fazendo signup ‚Üí login ‚Üí booking

### üéØ Por que Jest para Integra√ß√£o?

- **Velocidade**: Mais r√°pido que E2E (segundos vs minutos)
- **Confiabilidade**: Menos flaky que testes de navegador
- **CI/CD**: Ideal para pipelines de integra√ß√£o cont√≠nua
- **Debugging**: Mais f√°cil de debuggar que E2E

## Executando os Testes

### üöÄ Executar Todos os Testes de Integra√ß√£o
\`\`\`bash
# Executa todos os testes do diret√≥rio integration
npm test -- --testPathPattern=integration

# Alternativa mais espec√≠fica
npm test -- __tests__/integration/
\`\`\`

### üìÅ Executar Teste Espec√≠fico
\`\`\`bash
# Teste principal (recomendado - mais est√°vel)
npm test -- __tests__/integration/auth-integration.test.ts

# Testes espec√≠ficos por funcionalidade
npm test -- __tests__/integration/auth-flow.integration.test.tsx
npm test -- __tests__/integration/mentor-verification.integration.test.tsx
npm test -- __tests__/integration/appointment-calendar.integration.test.tsx
npm test -- __tests__/integration/test-runner.integration.test.tsx
\`\`\`

### üîç Executar com Op√ß√µes Avan√ßadas
\`\`\`bash
# Com coverage detalhado
npm test -- --testPathPattern=integration --coverage

# Modo watch (re-executa ao salvar)
npm test -- --testPathPattern=integration --watch

# Verbose (mostra todos os testes)
npm test -- --testPathPattern=integration --verbose

# Apenas testes que falharam
npm test -- --testPathPattern=integration --onlyFailures
\`\`\`

### üéØ Executar Testes por Categoria
\`\`\`bash
# Apenas testes de API
npm test -- --testNamePattern="API Endpoint"

# Apenas testes de erro
npm test -- --testNamePattern="Error Handling"

# Apenas testes de autentica√ß√£o
npm test -- --testNamePattern="Authentication Flow"

# Apenas testes de Google Calendar
npm test -- --testNamePattern="Google Calendar"
\`\`\`

### üìä Executar Todos os Tipos de Teste
\`\`\`bash
# Todos os testes (unit√°rios + integra√ß√£o)
npm test

# Apenas testes unit√°rios (exclui integra√ß√£o)
npm test -- --testPathIgnorePatterns=integration

# Com coverage completo
npm test -- --coverage --coverageDirectory=coverage
\`\`\`

### üêõ Debug e Desenvolvimento
\`\`\`bash
# Executa um teste espec√≠fico em modo debug
npm test -- __tests__/integration/auth-integration.test.ts --verbose --no-cache

# Para debuggar com breakpoints (VS Code)
npm test -- --runInBand --no-cache __tests__/integration/auth-integration.test.ts
\`\`\`

## üöÄ Comandos R√°pidos de Execu√ß√£o

### Executar Todos os Testes
\`\`\`bash
# Todos os testes de integra√ß√£o
npm test -- --testPathPattern=integration

# Teste principal (mais est√°vel)
npm test -- __tests__/integration/auth-integration.test.ts

# Com coverage
npm test -- --testPathPattern=integration --coverage
\`\`\`

### Executar Testes Espec√≠ficos
\`\`\`bash
# Por funcionalidade
npm test -- __tests__/integration/auth-flow.integration.test.tsx
npm test -- __tests__/integration/mentor-verification.integration.test.tsx
npm test -- __tests__/integration/appointment-calendar.integration.test.tsx

# Por categoria (usando pattern)
npm test -- --testNamePattern="API Endpoint"
npm test -- --testNamePattern="Error Handling"
npm test -- --testNamePattern="Google Calendar"
\`\`\`

### Modo Desenvolvimento
\`\`\`bash
# Watch mode (re-executa ao salvar)
npm test -- --testPathPattern=integration --watch

# Verbose (mostra detalhes)
npm test -- --testPathPattern=integration --verbose

# Debug espec√≠fico
npm test -- __tests__/integration/auth-integration.test.ts --verbose --no-cache
\`\`\`

## Test Requirements Validation

### ‚úÖ Requirement 4.5 - Complete Signup Flow
- [x] Email/password signup
- [x] OAuth provider signup (Google, LinkedIn)
- [x] Email confirmation handling
- [x] Profile creation after confirmation

### ‚úÖ Requirement 5.5 - Login with Different Providers
- [x] Email/password login
- [x] Google OAuth login
- [x] LinkedIn OAuth login
- [x] Error handling for unconfirmed emails
- [x] Invalid credential handling

### ‚úÖ Requirement 6.5 - Role Selection Flow
- [x] Mandatory role selection after signup
- [x] Mentor/mentee role options
- [x] Role persistence in database
- [x] Dashboard redirection based on role

### ‚úÖ Requirement 9.5 - Mentor Verification
- [x] Admin verification interface
- [x] Mentor status updates
- [x] Public listing integration
- [x] Access control validation

### ‚úÖ Requirement 11.5 - Appointment and Calendar
- [x] Appointment booking flow
- [x] Google Calendar event creation
- [x] Google Meet link generation
- [x] Conflict detection and handling

## Mock Strategy

The integration tests use a layered mocking approach:

1. **API Mocking**: Global `fetch` mock for API endpoint testing
2. **Component Mocking**: Minimal Next.js router mocking
3. **Service Mocking**: Supabase client mocking for database operations
4. **External Service Mocking**: Google Calendar API mocking

## Continuous Integration

These tests are designed to run in CI/CD environments and validate:
- API contract compliance
- Error handling robustness
- Security requirement adherence
- Business logic correctness
- Integration point stability

## Quando Usar Cada Tipo de Teste

### üß™ Testes Unit√°rios (Jest)
**Use quando:**
- Testar l√≥gica de uma fun√ß√£o espec√≠fica
- Validar comportamento de um hook isolado
- Testar componentes sem depend√™ncias externas

**Exemplo:**
\`\`\`javascript
// Testa apenas a fun√ß√£o de valida√ß√£o
test('should validate email format', () => {
  expect(validateEmail('test@example.com')).toBe(true)
  expect(validateEmail('invalid')).toBe(false)
})
\`\`\`

### üîó Testes de Integra√ß√£o (Jest + Testing Library)
**Use quando:**
- Testar fluxos completos de funcionalidades
- Validar integra√ß√£o entre m√∫ltiplos componentes
- Testar APIs e l√≥gica de neg√≥cio
- Validar contratos entre servi√ßos

**Exemplo:**
\`\`\`javascript
// Testa signup + confirma√ß√£o + role selection
test('should complete user onboarding flow', async () => {
  // Testa m√∫ltiplas etapas trabalhando juntas
})
\`\`\`

### üåê Testes E2E (Cypress/Playwright)
**Use quando:**
- Testar jornadas cr√≠ticas do usu√°rio
- Validar funcionalidade em navegadores reais
- Testar integra√ß√µes com servi√ßos externos reais
- Validar performance e acessibilidade

**Exemplo:**
\`\`\`javascript
// Cypress - testa no navegador real
cy.visit('/signup')
cy.get('[data-testid="email"]').type('user@example.com')
cy.get('[data-testid="submit"]').click()
cy.url().should('include', '/dashboard')
\`\`\`

## Estrat√©gia de Teste Recomendada

### üèóÔ∏è Pir√¢mide de Testes
\`\`\`
        /\
       /E2E\     ‚Üê Poucos, cr√≠ticos, lentos
      /____\
     /      \
    /Integr.\   ‚Üê Moderados, fluxos, m√©dios
   /________\
  /          \
 /  Unit√°rios \ ‚Üê Muitos, r√°pidos, isolados
/______________\
\`\`\`

### üìã Para Este Projeto:
- **70% Unit√°rios**: Fun√ß√µes, hooks, componentes isolados
- **25% Integra√ß√£o**: Fluxos de auth, APIs, l√≥gica de neg√≥cio
- **5% E2E**: Jornadas cr√≠ticas (signup, booking, payment)

## Future Enhancements

### üöÄ Pr√≥ximos Passos Recomendados:

1. **Testes E2E com Playwright**
   \`\`\`bash
   npm install @playwright/test
   # Criar testes para jornadas cr√≠ticas
   \`\`\`

2. **Testes de Performance**
   \`\`\`bash
   npm install @jest/test-utils
   # Testes de load para APIs cr√≠ticas
   \`\`\`

3. **Testes Visuais**
   \`\`\`bash
   npm install @storybook/test-runner
   # Screenshot testing para componentes
   \`\`\`

4. **Testes de Acessibilidade**
   \`\`\`bash
   npm install @axe-core/playwright
   # Valida√ß√£o autom√°tica de a11y
   \`\`\`

5. **Testes de Banco Real**
   \`\`\`bash
   # Docker + PostgreSQL para testes de integra√ß√£o
   # Migrations autom√°ticas para ambiente de teste
   \`\`\`
